#https://medium.com/splunkuserdeveloperadministrator/creating-mysql-databases-with-ansible-925ab28598ab
#sudo ansible-galaxy install  --roles-path=/etc/ansible/roles/ geerlingguy.mysql --force
#
---
- name: Install MySQL Using Ansible Role
  hosts: all
  become: yes
  become_user: root
  vars:
   user_password: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            32356130383065343064623666623861626162356566313336636437306364653565366361643839
            3737393164363066636236616464343563393131313530660a356239626336656533623135303763
            63383563613463643935613638663465613735646466373662393131613031303431356435616464
            3164393666333832650a373266326131396465663938663139363833323565623734353633346532
            6463
  roles:
  - { role: geerlingguy.mysql }
  tasks:
  - name: create a new database 
    mysql_db: >
      name=myflixdb 
      state=present 
      login_user=root
    tags:
    - mysql
  - name: Copy sample data to tmp folder 
    copy: src=/root/Ansible/playbooks/Roles/dump.sql dest=/tmp/dump.sql
    tags:
    - mysql
  - name: insert sample data into database
    mysql_db: name=myflixdb state=import target=/tmp/dump.sql
    tags:
    - mysql
  - name: Add records to MySQL
    mysql_db: name=myflixdb state=import target=/tmp/dump.sql
    tags:
    - mysql

  - name: Removes all anonymous user accounts
    community.mysql.mysql_user:
      name: ''
      host_all: yes
      state: absent

  - name: Create database user with name 'bob' and password from vault.
    community.mysql.mysql_user:
      name: bob
      password: "{{ '%s' | format(user_password) | regex_replace('\n', '') | password_hash('sha512') }}"
      priv: '*.*:ALL,GRANT'
      host: "localhost"
      state: present

  - name: Create database user with name 'charlie' and password from vault.
    community.mysql.mysql_user:
      name: charlie
      password: "{{ '%s' | format(user_password) | regex_replace('\n', '') | password_hash('sha512') }}"
      priv: '*.*:ALL,GRANT'
      host: 'localhost'
      state: present
    

  