#https://medium.com/splunkuserdeveloperadministrator/creating-mysql-databases-with-ansible-925ab28598ab
#sudo ansible-galaxy install  --roles-path=/etc/ansible/roles/ geerlingguy.mysql --force
#
---
- name: Install MySQL Using Ansible Role
  hosts: all
  become: yes
  become_user: root
  vars:
   user_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61376362373264666261393135323336306531633831376465303735613839633466383834666338
          6465386531343262663466646263633936366336346430310a623664623030356362343432303233
          33343263643938626139383533376634623938343565623039376262636465653065353663653036
          6464336139373437660a393731633839393138336165313564633365343836663734323233383636
          3036
  roles:
  - { role: geerlingguy.mysql }
  tasks:
  - name: create a new database 
    mysql_db: >
      name=myflixdb 
      state=present 
      login_user=root
    tags:
    - mysql
  - name: Copy sample data to tmp folder 
    copy: src=/root/devsecopsb35-ansible-code/Playbooks/Roles/dump.sql dest=/tmp/dump.sql
    tags:
    - mysql
  - name: insert sample data into database
    mysql_db: name=myflixdb state=import target=/tmp/dump.sql
    tags:
    - mysql
  - name: Add records to MySQL
    mysql_db: name=myflixdb state=import target=/tmp/dump.sql
    tags:
    - mysql

  - name: Removes all anonymous user accounts
    community.mysql.mysql_user:
      name: ''
      host_all: yes
      state: absent

  - name: Create database user with name 'bob' and password from vault.
    community.mysql.mysql_user:
      name: bob
      password: "{{ '%s' | format(user_password) | regex_replace('\n', '') | password_hash('sha512') }}"
      priv: '*.*:ALL,GRANT'
      host: "localhost"
      state: present

  - name: Create database user with name 'charlie' and password from vault.
    community.mysql.mysql_user:
      name: charlie
      password: "{{ '%s' | format(user_password) | regex_replace('\n', '') | password_hash('sha512') }}"
      priv: '*.*:ALL,GRANT'
      host: 'localhost'
      state: present
    

  